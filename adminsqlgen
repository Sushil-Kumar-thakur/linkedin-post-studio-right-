-- Fix infinite recursion in admin_users RLS policy
-- Drop the existing recursive policy
DROP POLICY IF EXISTS "Only admins can view admin users" ON public.admin_users;

-- Create a security definer function to check admin status without recursion
CREATE OR REPLACE FUNCTION public.is_admin(user_uuid uuid DEFAULT auth.uid())
RETURNS boolean
LANGUAGE sql
SECURITY DEFINER
STABLE
AS $$
  SELECT EXISTS (
    SELECT 1 
    FROM public.admin_users 
    WHERE user_id = user_uuid AND role = 'admin'
  );
$$;

-- Create new non-recursive policy using the security definer function
CREATE POLICY "Only admins can view admin users" 
ON public.admin_users 
FOR SELECT 
USING (public.is_admin());